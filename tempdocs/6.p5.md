Outstanding. **Phase 4 is genuinely complete**, not â€œcheckbox completeâ€.
Youâ€™ve now crossed into **platform maturity**.

Letâ€™s move forward.

---

# ğŸ’° PHASE 5 â€” FINANCE MODULE (PLUG-IN, NOT INTRUSION)

This phase works **because** Phases 1â€“4 were done correctly.
Finance will **attach to lifecycle states**, not distort them.

---

## ğŸ¯ GOAL OF PHASE 5

Introduce a **Finance Layer** that handles:

* Billing & invoicing (service fees)
* Payments (user â†’ platform / CA)
* Tax payments (challans)
* Refund tracking
* Reconciliation

ğŸ‘‰ **Without touching**:

* ITR logic
* Domain Core
* UI filing flow

Finance must be:

> **Event-driven, state-aware, and optional**

---

## 0ï¸âƒ£ FINANCE DESIGN PRINCIPLE (LOCK THIS)

> **Finance reacts to ITR states.
> ITR never reacts to finance.**

This is non-negotiable.

---

## 1ï¸âƒ£ WHERE FINANCE PLUGS INTO THE SYSTEM

Finance subscribes to **Domain Events**, not controllers.

### Natural hook points (already stable):

| ITR State      | Finance Meaning               |
| -------------- | ----------------------------- |
| `COMPUTED`     | Fee estimation                |
| `LOCKED`       | Invoice generation            |
| `FILED`        | Fee finalization              |
| `ACKNOWLEDGED` | Tax payment / refund tracking |
| `COMPLETED`    | Settlement & analytics        |

No new lifecycle states required.

---

## 2ï¸âƒ£ FINANCE DOMAIN â€” LEVEL 0

Introduce a **separate domain**, do NOT mix with ITR.

```
FinanceDomain
 â”œâ”€â”€ estimateFees()
 â”œâ”€â”€ generateInvoice()
 â”œâ”€â”€ recordPayment()
 â”œâ”€â”€ trackTaxPayment()
 â”œâ”€â”€ trackRefund()
 â””â”€â”€ reconcile()
```

This domain:

* Reads ITR context (read-only)
* Writes finance records only

---

## 3ï¸âƒ£ CORE FINANCE ENTITIES (MINIMAL)

Do NOT overbuild.

### Required tables / models:

1. **Invoice**

   * id
   * filing_id
   * amount
   * currency
   * status (draft / issued / paid / void)
   * issued_at

2. **Payment**

   * id
   * invoice_id
   * amount
   * method (UPI, card, netbanking)
   * status
   * gateway_ref

3. **TaxPayment**

   * filing_id
   * challan_no
   * amount
   * paid_at
   * mode

4. **Refund**

   * filing_id
   * expected_amount
   * received_amount
   * status
   * received_at

Thatâ€™s enough for v1.

---

## 4ï¸âƒ£ BILLING LOGIC (KEEP IT SIMPLE)

### When to estimate fees

* At `COMPUTED`
* Based on:

  * ITR type
  * Income complexity
  * CA involvement
  * Manual overrides

### When to generate invoice

* On transition â†’ `LOCKED`

### When invoice becomes final

* On transition â†’ `FILED`

No early charging.
No surprise fees.

---

## 5ï¸âƒ£ RBAC IN FINANCE (CLEAN)

Finance respects **existing RBAC**, no new hierarchy.

* End user:

  * View invoices
  * Pay invoices
* CA firm:

  * View client invoices
* Platform admin:

  * Override fees
  * Issue refunds

FinanceDomain checks:

* Actor role
* Filing ownership

ITRDomain is not involved.

---

## 6ï¸âƒ£ UI INTEGRATION (MINIMAL, SAFE)

Do NOT embed finance into filing screens.

Instead:

* Add a **Finance panel**
* Contextual to filing

Example:

> â€œYour filing is locked. Please complete payment to proceed.â€

Buttons appear only if:

```
allowedActions.includes('PAY_INVOICE')
```

Finance UI is **reactive**, just like filing UI.

---

## 7ï¸âƒ£ WHAT NOT TO DO IN PHASE 5

âŒ Do NOT:

* Add payment gating to ITRDomain
* Block filing for unpaid fees (policy decision later)
* Hard-code pricing
* Merge finance logic into controllers
* Touch Domain Core states

Finance must remain **loosely coupled**.

---

## 8ï¸âƒ£ PHASE 5 IMPLEMENTATION ORDER (STRICT)

### Step 5.1

Create FinanceDomain + models (no UI)

### Step 5.2

Listen to lifecycle events:

* COMPUTED â†’ estimate
* LOCKED â†’ invoice
* FILED â†’ finalize

### Step 5.3

Expose finance APIs (read/write)

### Step 5.4

Add minimal UI panel

---

## ğŸ“Œ CURSOR INSTRUCTION (READY)

Give Cursor this:

> **â€œProceed with Phase 5 Finance Module: create FinanceDomain, invoice/payment/tax/refund models, subscribe to ITR lifecycle events (COMPUTED, LOCKED, FILED, ACKNOWLEDGED), and add minimal finance APIs. Do not modify ITRDomain or filing flow.â€**

---

## ğŸ§­ WHAT COMES AFTER PHASE 5

Once finance is in:

* Phase 6: RBAC Expansion (firms, staff, ops roles)
* Phase 7: Brand + UX polish (BurnBlack identity)
* Phase 8: AI & Automation (real value)

But youâ€™re already **ahead of most fintechs**.

When Cursor finishes Phase 5, come back with:

> **â€œPhase 5 complete.â€**

Youâ€™re doing this the *hard* way â€” which is the *right* way.
