
## ITR DOMAIN CORE â†’ CODEBASE MAPPING TASK

### Objective

Map the **existing codebase** to the **ITR Domain Core State Machine**, enforce **state-based legality**, and identify **logic leaks**, **duplication**, and **missing guards**.

Do **NOT** refactor yet.
This is a **mapping + annotation task only**.

---

## 1ï¸âƒ£ Define the Authoritative Domain States (ENUM)

Create (conceptually or in code comments):

```
DRAFT_INIT
ITR_DETERMINED
DATA_COLLECTED
DATA_CONFIRMED
COMPUTED
LOCKED
FILED
ACKNOWLEDGED
COMPLETED
```

These are the **only valid lifecycle states**.

---

## 2ï¸âƒ£ Identify the Domain Owner (Single Authority)

Designate a **Domain Core module** (name flexible, e.g.):

```
/backend/src/domain/ITRDomainCore.js
```

Its responsibility:

* Decide state transitions
* Decide ITR type
* Decide allowed actions
* Decide recomputation / invalidation

âŒ Controllers, UI, services must NOT decide these.

---

## 3ï¸âƒ£ Map Existing Backend Files â†’ Domain Responsibilities

### A. Controllers (ANNOTATE ONLY)

For each controller method (especially in `ITRController`, `eriController`, `ITRVController`):

Add comments or notes:

* Which **lifecycle state** this action assumes
* Which **state transition** it intends
* Whether it **mutates data**, **computes**, or **files**

Flag:

* âŒ If it mutates data in `LOCKED` or later
* âš ï¸ If it implicitly assumes ITR type
* âš ï¸ If it triggers compute without domain approval

---

### B. Services (CLASSIFY)

Classify every service into one of:

1. **Pure Domain-Independent**

   * `TaxComputationEngine`
   * `Form16ExtractionService`
   * `BrokerFileProcessor`
   * `RefundTrackingService`

2. **Domain-Dependent (Must be gated)**

   * `ITRAutoDetectorService`
   * `ValidationEngine`
   * `TaxComputationService`
   * `DeductionDetectionService`

For category (2), annotate:

> â€œMust only execute if Domain Core allows action in current stateâ€

---

### C. Models (VERIFY INVARIANTS)

For `ITRDraft`, `ITRFiling`, `ReturnVersion`:

* Identify which fields imply **state**
* Identify which fields should be **immutable after LOCKED**
* Flag any update paths that bypass state checks

---

## 4ï¸âƒ£ Frontend Mapping Rules (STRICT)

For frontend pages / components:

### Rule

Frontend **must not decide legality**.

For each major ITR page / flow:

* Identify which **Domain State** it belongs to
* Replace assumptions like:

  * â€œStep 3â€
  * â€œNext sectionâ€
    With:
  * `allowed_actions[]` from backend

Flag:

* âŒ Any frontend logic that infers ITR type
* âŒ Any frontend logic that blocks actions without backend confirmation

---

## 5ï¸âƒ£ ITR Switching Logic (Critical)

Search for:

* ITR type checks
* Conditional UI or backend logic based on ITR-1/2/3/4

For each:

* Annotate whether it should be:

  * Domain decision
  * Validation rule
  * UI rendering only

Rule:

> **Only Domain Core can change ITR type**

Everything else reacts.

---

## 6ï¸âƒ£ Override & Audit Mapping

For every place where:

* CA edits values
* Admin edits values
* System auto-corrects data

Annotate:

* Which state this happens in
* Whether override reason is mandatory
* Whether audit is triggered

Rule:

> Override allowed ONLY in `COMPUTED`, never after `LOCKED`

---

## 7ï¸âƒ£ Finance & RBAC Readiness (DO NOT IMPLEMENT)

Just annotate future hooks:

* Billing hooks at:

  * `COMPUTED`
  * `LOCKED`
  * `FILED`
* RBAC checks should only:

  * Gate **who** can perform an allowed action
  * Never decide **what** is allowed

---

## 8ï¸âƒ£ Final Output Expected from Cursor

Cursor should produce:

1. A **mapping document**:

   * File â†’ Lifecycle State(s)
   * File â†’ Allowed Actions
2. A list of:

   * âŒ State violations
   * âš ï¸ Logic duplication
   * ğŸŸ¡ Missing Domain Core checks
3. A short summary:

   * â€œDomain-readyâ€
   * â€œNeeds consolidationâ€
   * â€œUnsafe logicâ€

NO refactoring yet.

---

## 9ï¸âƒ£ Non-Negotiable Rule

If any code:

* Mutates ITR data
* Computes tax
* Switches ITR
* Locks filing

ğŸ‘‰ It **must** go through Domain Core in future.

For now, just **identify & mark**.

---

### âœ… End of Instruction

---

Youâ€™re doing this **exactly right**:

* Domain first
* Mapping second
* Refactor last

Once Cursor finishes this mapping, **weâ€™ll know precisely**:

* What to keep
* What to consolidate
* What to delete
* What to elevate into the Domain Core

When youâ€™re ready, say **â€œmapping doneâ€** and weâ€™ll do the **next surgical step**.
